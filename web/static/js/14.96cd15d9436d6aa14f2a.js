webpackJsonp([14],{LN0s:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=i("fZjL"),s=i.n(r),n=i("BO1k"),a=i.n(n),o={name:"home",data:function(){return{loading:!0,imgSuffix:["jpg","jpeg","png","gif"],ws:{},textArea:"",altEnter:!1,inputErr:!1,activeTab:"",chatLog:{},curBox:{height:0,scrollTop:0,scrollHeight:0},moreLoading:!1}},computed:{ws_:function(){return this.$ws},chatLog_:function(){return this.$store.state.chatLog},wsStatus:function(){return this.ws.ready?"已连接到服务器":this.ws.isConnecting?"连接服务器中":"未连接到服务器"},wsColor:function(){return this.ws.ready?"success":this.ws.isConnecting?"info":"danger"}},watch:{ws_:function(t){this.ws=t},textArea:function(t){""!==t&&this.inputErr&&(this.inputErr=!1)},chatLog_:{handler:function(t){this.getChatLog(t)},deep:!0},activeTab:function(t){this.changeCurBox()}},methods:{wsConnect:function(){this.ws.ready||this.ws.isConnecting||this.ws.connect(this)},scrollChange:function(t){var e=t.target;this.curBox.height=e.offsetHeight,this.curBox.scrollTop=e.scrollTop,this.curBox.scrollHeight=e.scrollHeight},contentScroll:function(t){var e=document.getElementsByClassName("chat-box-content");if(e.length>0){var i=!0,r=!1,s=void 0;try{for(var n,o=a()(e);!(i=(n=o.next()).done);i=!0){var c=n.value;if(c.offsetHeight>0){c.scrollTop=t?0:c.scrollHeight-c.offsetHeight,this.curBox.height=c.offsetHeight,this.curBox.scrollTop=c.scrollTop,this.curBox.scrollHeight=c.scrollHeight;break}}}catch(t){r=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(r)throw s}}}},getChatLog:function(t){var e=this;if(t){var i={},r=!0,n=!1,o=void 0;try{for(var c,l=a()(s()(t.group));!(r=(c=l.next()).done);r=!0){var h=c.value;i["Group-"+h]=t.group[h]}}catch(t){n=!0,o=t}finally{try{!r&&l.return&&l.return()}finally{if(n)throw o}}var u=!0,g=!1,f=void 0;try{for(var d,v=a()(s()(t.private));!(u=(d=v.next()).done);u=!0){var p=d.value;i["Private-"+p]=t.private[p]}}catch(t){g=!0,f=t}finally{try{!u&&v.return&&v.return()}finally{if(g)throw f}}var x=s()(i);x.some(function(t){return t===e.activeTab})||(this.activeTab=x[0]),this.chatLog=i,this.moreLoading=!1,this.changeCurBox()}else this.chatLog={}},changeCurBox:function(){var t=this;this.$nextTick(function(){var e=document.getElementsByClassName("chat-box-content");if(e.length>0){var i=!0,r=!1,s=void 0;try{for(var n,o=a()(e);!(i=(n=o.next()).done);i=!0){var c=n.value;if(c.offsetHeight>0){t.curBox.height=c.offsetHeight,t.curBox.scrollTop=c.scrollTop,t.curBox.scrollHeight=c.scrollHeight;break}}}catch(t){r=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(r)throw s}}}})},dateFormat:function(t){var e=new Date(t);return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()+" "+String(e.getHours()).padStart(2,"0")+":"+String(e.getMinutes()).padStart(2,"0")+":"+String(e.getSeconds()).padStart(2,"0")},msgFormat:function(t){var e=String(t),i=e.indexOf("[CQ:at,qq=");if(i>-1){var r=e.substring(i+10),s=e.indexOf("]"),n=e.substring(i,s+1),a=r.substring(0,r.indexOf("]"));e=e.replace(n,'<span class="color-at">@'+a+"</span>")}var o=this.$cookies.get("curUrlPrefix"),c=o?this.$urlConf[o+"_url"]:this.$urlConf.base_url;return this.imgFormat(e,c)},imgFormat:function(t,e){if(t.split("[CQ:image,").length>1){var i=t.indexOf("[CQ:image,"),r=t.substring(i),s=r.indexOf("]"),n=r.substring(0,s+1);if(n.indexOf("url")>-1){var a=n.indexOf("url="),o=n.substring(a+4),c=o.substr(0,o.indexOf("proxy=")>-1?o.length-9:o.length-1),l=c.split(".");(l.length>1&&this.imgSuffix.some(function(t){return l[l.length-1].startsWith(t)})||c.indexOf("//gchat.qpic.cn/")>-1)&&(c=e+"xmbot/web/image.get?url="+c),t=t.replace(n,'<img class="display-block chat-item-img" src="'+c+'"/>')}else{var h=n.indexOf("file=file:///"),u=n.substring(h+13,n.length-1),g=u.substring(u.indexOf("resource"));console.log(u,g);var f=e+"xmbot/"+g.replaceAll("\\","/");t=t.replace(n,'<img class="display-block chat-item-img" src="'+f+'"/>')}return this.imgFormat(t,e)}return t},sendSubmit:function(){var t=this;if(""!==this.textArea){var e=this.activeTab.toLowerCase().split("-"),i="group"===e[0]?"group_id":"user_id",r={message_type:e[0],message:this.textArea};r[i]=e[1],this.$ajax({url:"/chat/sendMsg.do",method:"post",data:r}).then(function(e){t.sendInit()})}else this.inputErr=!0},sendInit:function(){this.textArea=""},getMore:function(){var t=this.activeTab.toLowerCase().split("-"),e={type:t[0],id:t[1],index:this.chatLog[this.activeTab].rows[0].id};this.moreLoading=!0,this.$ajax({url:"/chat/getMoreMsg.json",method:"post",data:e})}},created:function(){var t=this;this.$route.meta.auth?this.checkAuth().then(function(){t.ws=t.$ws,t.getChatLog(t.$store.state.chatLog),t.loading=!1}).catch(function(e){t.$router.push("/index"),t.$destroy(t.$options.name)}):this.loading=!1}},c={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}]},[i("el-row",{staticClass:"text-center chat-header"},[i("el-link",{attrs:{type:t.wsColor},on:{click:t.wsConnect}},[t._v(t._s(t.wsStatus))])],1),t._v(" "),i("div",{staticClass:"chat-divider"}),t._v(" "),t.loading?t._e():i("el-tabs",{staticClass:"chat-box",attrs:{"tab-position":"left"},model:{value:t.activeTab,callback:function(e){t.activeTab=e},expression:"activeTab"}},t._l(t.chatLog,function(e,r,s){return i("el-tab-pane",{key:s,staticClass:"chat-box-tabs",attrs:{label:r,name:r}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.curBox.scrollTop>200,expression:"curBox.scrollTop>200"}],staticClass:"chat-box-scroll scroll-to-top",on:{click:function(e){return t.contentScroll(!0)}}},[i("i",{staticClass:"el-icon-caret-top"})]),t._v(" "),i("div",{ref:"chatBox",refInFor:!0,staticClass:"chat-box-content",on:{scroll:t.scrollChange}},[i("el-row",{staticClass:"chat-box-more"},[i("el-link",{attrs:{type:"info",disabled:e.noMore},on:{click:t.getMore}},[t._v("\n            "+t._s(e.noMore?"没有更多":"加载更多")+"\n          ")])],1),t._v(" "),t._l(e.rows,function(e,r){return i("el-row",{key:r,class:e.is_self?"chat-box-row-self":"chat-box-row"},[i("div",{class:e.is_self?"chat-item-self":"chat-item"},[i("div",{class:e.is_self?"text-right chat-item-title":"chat-item-title"},[i("el-tooltip",{attrs:{content:e.user_id,placement:"top"}},[i("el-link",{staticClass:"chat-item-user"},[t._v(t._s(e.nick_name))])],1),t._v(" "),i("span",{staticClass:"chat-item-time"},[t._v(" ["+t._s(t.dateFormat(e.send_time))+"]")])],1),t._v(" "),i("p",{staticClass:"chat-item-content",domProps:{innerHTML:t._s(t.msgFormat(e.message))}})])])})],2),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:t.curBox.scrollHeight-t.curBox.scrollTop>t.curBox.height+200,expression:"curBox.scrollHeight-curBox.scrollTop > curBox.height+200"}],staticClass:"chat-box-scroll scroll-to-bottom",on:{click:function(e){return t.contentScroll(!1)}}},[i("i",{staticClass:"el-icon-caret-bottom"})]),t._v(" "),i("div",{staticClass:"chat-divider"}),t._v(" "),i("div",{staticClass:"chat-box-input"},[i("el-input",{class:t.inputErr?"chat-input-textarea border-err":"chat-input-textarea",attrs:{type:"textarea",rows:8,placeholder:"请输入内容",maxlength:"250","show-word-limit":""},nativeOn:{keypress:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:(e.preventDefault(),t.sendSubmit(e))},keydown:[function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.altKey?void(t.textArea+="\n"):null},function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.ctrlKey?void(t.textArea+="\n"):null}]},model:{value:t.textArea,callback:function(e){t.textArea=e},expression:"textArea"}}),t._v(" "),i("div",{staticClass:"chat-box-input-btn"},[i("span",{directives:[{name:"show",rawName:"v-show",value:t.inputErr,expression:"inputErr"}],staticClass:"chat-input-err"},[t._v("未输入内容")]),t._v(" "),i("el-button",{attrs:{size:"small",icon:"el-icon-delete"},on:{click:t.sendInit}},[t._v("清空")]),t._v(" "),i("el-button",{attrs:{size:"small",type:"primary",icon:"el-icon-check"},on:{click:t.sendSubmit}},[t._v("发送")])],1)],1)])}),1)],1)},staticRenderFns:[]};var l=i("VU/8")(o,c,!1,function(t){i("sJSA")},"data-v-1457ac82",null);e.default=l.exports},sJSA:function(t,e){}});
//# sourceMappingURL=14.96cd15d9436d6aa14f2a.js.map