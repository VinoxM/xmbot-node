webpackJsonp([17],{JdDw:function(t,e){},LN0s:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i("fZjL"),s=i.n(n),r=i("BO1k"),a=i.n(r),o={name:"home",data:function(){return{loading:!0,imgSuffix:["jpg","jpeg","png","gif"],ws:{},textArea:"",altEnter:!1,inputErr:!1,activeTab:"",chatLog:{},curBox:{height:0,scrollTop:0,scrollHeight:0},hideInput:!1}},computed:{isAdmin:function(){return this.$store.state.isAdmin},ws_:function(){return this.$ws},chatLog_:function(){return this.$store.state.chatLog},wsStatus:function(){return this.ws.ready?"已连接到服务器":this.ws.isConnecting?"连接服务器中":"未连接到服务器"},wsColor:function(){return this.ws.ready?"success":this.ws.isConnecting?"info":"danger"}},watch:{ws_:function(t){this.ws=t},textArea:function(t){""!==t&&this.inputErr&&(this.inputErr=!1)},chatLog_:{handler:function(t){this.getChatLog(t)},deep:!0},activeTab:function(t){this.changeCurBox(),this.chatLog[t]&&this.chatLog[t].hasOwnProperty("hasNew")&&this.chatLog[t].hasNew&&this.scrollToBottom()}},methods:{wsConnect:function(){this.ws.ready||this.ws.isConnecting||this.ws.connect(this)},scrollChange:function(t){var e=t.target;this.curBox.height=e.offsetHeight,this.curBox.scrollTop=e.scrollTop,this.curBox.scrollHeight=e.scrollHeight},contentScroll:function(t){var e=document.getElementsByClassName("chat-box-content");if(e.length>0){var i=!0,n=!1,s=void 0;try{for(var r,o=a()(e);!(i=(r=o.next()).done);i=!0){var l=r.value;if(l.offsetHeight>0){l.scrollTop=t?0:l.scrollHeight-l.offsetHeight,this.curBox.height=l.offsetHeight,this.curBox.scrollTop=l.scrollTop,this.curBox.scrollHeight=l.scrollHeight;break}}}catch(t){n=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(n)throw s}}}},hideInputToggle:function(t){var e=!1;if(!t){var i=document.getElementsByClassName("chat-box-content");if(i.length>0){var n=!0,s=!1,r=void 0;try{for(var o,l=a()(i);!(n=(o=l.next()).done);n=!0){var c=o.value;if(c.offsetHeight>0){e=c.scrollHeight-c.offsetHeight<=c.scrollTop;break}}}catch(t){s=!0,r=t}finally{try{!n&&l.return&&l.return()}finally{if(s)throw r}}}}this.hideInput=t,e&&this.scrollToBottom()},getChatLog:function(t){var e=this;if(t){var i={},n=!0,r=!1,o=void 0;try{for(var l,c=a()(s()(t.group));!(n=(l=c.next()).done);n=!0){var h=l.value;t.group[h].rows.map(function(t){return t.message=e.msgFormat(t.message),t}),i["Group-"+h]=t.group[h]}}catch(t){r=!0,o=t}finally{try{!n&&c.return&&c.return()}finally{if(r)throw o}}var u=!0,g=!1,d=void 0;try{for(var f,v=a()(s()(t.private));!(u=(f=v.next()).done);u=!0){var p=f.value;t.private[p].rows.map(function(t){return t.message=e.msgFormat(t.message),t}),i["Private-"+p]=t.private[p]}}catch(t){g=!0,d=t}finally{try{!u&&v.return&&v.return()}finally{if(g)throw d}}var m=s()(i);m.some(function(t){return t===e.activeTab})||(this.activeTab=m[0]),this.chatLog=i,this.changeCurBox(),this.chatLog[this.activeTab]&&this.chatLog[this.activeTab].hasNew&&this.scrollToBottom()}else this.chatLog={}},changeCurBox:function(){var t=this;this.$nextTick(function(){var e=document.getElementsByClassName("chat-box-content");if(e.length>0){var i=!0,n=!1,s=void 0;try{for(var r,o=a()(e);!(i=(r=o.next()).done);i=!0){var l=r.value;if(l.offsetHeight>0){t.curBox.height=l.offsetHeight,t.curBox.scrollTop=l.scrollTop,t.curBox.scrollHeight=l.scrollHeight;break}}}catch(t){n=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(n)throw s}}}})},scrollToBottom:function(){var t=this;this.$nextTick(function(){var e=document.getElementsByClassName("chat-box-content");if(e.length>0){var i=!0,n=!1,s=void 0;try{for(var r,o=a()(e);!(i=(r=o.next()).done);i=!0){var l=r.value;if(l.offsetHeight>0){l.scrollTop=l.scrollHeight,t.curBox.height=l.offsetHeight,t.curBox.scrollTop=l.scrollTop,t.curBox.scrollHeight=l.scrollHeight,t.chatLog[t.activeTab].hasNew=!1,t.chatLog[t.activeTab].newCount=0;break}}}catch(t){n=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(n)throw s}}}})},dateFormat:function(t){var e=new Date(t);return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()+" "+String(e.getHours()).padStart(2,"0")+":"+String(e.getMinutes()).padStart(2,"0")+":"+String(e.getSeconds()).padStart(2,"0")},msgFormat:function(t){var e=String(t),i=(e=e.replaceAll("\n","<br/>")).indexOf("[CQ:at,qq=");if(i>-1){var n=e.substring(i+10),s=e.indexOf("]"),r=e.substring(i,s+1),a=n.substring(0,n.indexOf("]"));e=e.replace(r,'<span class="color-at">@'+a+"</span>")}var o=this.$cookies.get("curUrlPrefix"),l=o?this.$urlConf[o+"_url"]:this.$urlConf.base_url;return this.imgFormat(e,l)},imgFormat:function(t,e){if(t.split("[CQ:image,").length>1){var i=t.indexOf("[CQ:image,"),n=t.substring(i),s=n.indexOf("]"),r=n.substring(0,s+1);if(r.indexOf("url")>-1){var a=r.indexOf("url="),o=r.substring(a+4),l=o.substr(0,o.indexOf("proxy=")>-1?o.length-9:o.length-1),c=l.split(".");(c.length>1&&this.imgSuffix.some(function(t){return c[c.length-1].startsWith(t)})||l.indexOf("//gchat.qpic.cn/")>-1)&&(l=e+"xmbot/web/image.get?url="+l),t=t.replace(r,'<img class="display-block chat-item-img" src="'+l+'"/>')}else{var h=r.indexOf("file=file:///"),u=r.substring(h+13,r.length-1),g=e+"xmbot/"+u.substring(u.indexOf("resource")).replaceAll("\\","/");t=t.replace(r,'<img class="display-block chat-item-img" src="'+g+'"/>')}return this.imgFormat(t,e)}return t},sendSubmit:function(){var t=this;if(""!==this.textArea){var e=this.activeTab.toLowerCase().split("-"),i="group"===e[0]?"group_id":"user_id",n={message_type:e[0],message:this.textArea};n[i]=e[1].split("_")[0],n.apiName=e[1].split("_")[1],this.$ajax({url:"/chat/sendMsg.do",method:"post",data:n}).then(function(e){t.sendInit()})}else this.inputErr=!0},sendInit:function(){this.textArea=""},getMore:function(){var t=this.activeTab.toLowerCase().split("-"),e={type:t[0],id:t[1],apiName:t[2],index:this.chatLog[this.activeTab].rows[0].id};this.moreLoading=!0,this.$ajax({url:"/chat/getMoreMsg.json",method:"post",data:e})}},created:function(){var t=this;this.$route.meta.auth?this.checkAuth().then(function(){t.ws=t.$ws,t.getChatLog(t.$store.state.chatLog),t.loading=!1,t.hideInput=!t.isAdmin}).catch(function(e){t.$router.push("/index"),t.$destroy(t.$options.name)}):this.loading=!1}},l={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}]},[i("el-row",{staticClass:"text-center chat-header"},[i("el-link",{attrs:{type:t.wsColor},on:{click:t.wsConnect}},[t._v(t._s(t.wsStatus))])],1),t._v(" "),i("div",{staticClass:"chat-divider"}),t._v(" "),t.loading?t._e():i("el-tabs",{staticClass:"chat-box",attrs:{"tab-position":"left"},model:{value:t.activeTab,callback:function(e){t.activeTab=e},expression:"activeTab"}},t._l(t.chatLog,function(e,n,s){return i("el-tab-pane",{key:s,staticClass:"chat-box-tabs",attrs:{name:n}},[i("div",{attrs:{slot:"label"},slot:"label"},[0===e.newCount?i("span",[t._v(t._s(n))]):i("el-badge",{staticStyle:{"vertical-align":"top"},attrs:{value:e.newCount,max:99}},[i("span",[t._v(t._s(n))])])],1),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:t.curBox.scrollTop>200,expression:"curBox.scrollTop>200"}],staticClass:"chat-box-scroll scroll-to-top",on:{click:function(e){return t.contentScroll(!0)}}},[i("i",{staticClass:"el-icon-caret-top"})]),t._v(" "),i("div",{ref:"chatBox",refInFor:!0,class:t.hideInput?"chat-box-content content-tall":"chat-box-content",on:{scroll:t.scrollChange}},[i("el-row",{staticClass:"chat-box-more"},[i("el-link",{attrs:{type:"info",disabled:e.noMore},on:{click:t.getMore}},[t._v("\n            "+t._s(e.noMore?"没有更多":"加载更多")+"\n          ")])],1),t._v(" "),t._l(e.rows,function(e,n){return i("el-row",{key:n,class:e.is_self?"chat-box-row-self":"chat-box-row"},[i("div",{class:e.is_self?"chat-item-self":"chat-item"},[i("div",{class:e.is_self?"text-right chat-item-title":"chat-item-title"},[i("el-tooltip",{attrs:{content:e.user_id,placement:"top"}},[i("el-link",{staticClass:"chat-item-user"},[t._v(t._s(e.nick_name))])],1),t._v(" "),i("span",{staticClass:"chat-item-time"},[t._v(" ["+t._s(t.dateFormat(e.send_time))+"]")])],1),t._v(" "),i("p",{staticClass:"chat-item-content",domProps:{innerHTML:t._s(e.message)}})])])})],2),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:t.curBox.scrollHeight-t.curBox.scrollTop>t.curBox.height+200,expression:"curBox.scrollHeight-curBox.scrollTop > curBox.height+200"}],class:t.hideInput?"chat-box-scroll scroll-to-bottom-tall":"chat-box-scroll scroll-to-bottom",on:{click:function(e){return t.contentScroll(!1)}}},[i("i",{staticClass:"el-icon-caret-bottom"})]),t._v(" "),i("div",{class:t.hideInput?"chat-divider-tall":"chat-divider"},[t.hideInput?i("span",{staticClass:"input-open-btn",on:{click:function(e){return t.hideInputToggle(!1)}}},[i("i",{staticClass:"el-icon-d-arrow-left"})]):t._e()]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:!t.hideInput,expression:"!hideInput"}],staticClass:"chat-box-input"},[i("el-input",{class:t.inputErr?"chat-input-textarea border-err":"chat-input-textarea",attrs:{readonly:!t.isAdmin,type:"textarea",rows:6,placeholder:t.isAdmin?"请输入内容":"权限不足",maxlength:"250","show-word-limit":""},nativeOn:{keypress:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:(e.preventDefault(),t.sendSubmit(e))},keydown:[function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.altKey?void(t.textArea+="\n"):null},function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.ctrlKey?void(t.textArea+="\n"):null}]},model:{value:t.textArea,callback:function(e){t.textArea=e},expression:"textArea"}}),t._v(" "),i("div",{staticClass:"chat-box-input-btn"},[i("span",{directives:[{name:"show",rawName:"v-show",value:t.inputErr,expression:"inputErr"}],staticClass:"chat-input-err"},[t._v("未输入内容")]),t._v(" "),i("el-button",{staticClass:"icon-translate-90",attrs:{size:"small",icon:"el-icon-d-arrow-right"},on:{click:function(e){return t.hideInputToggle(!0)}}},[t._v("收起\n          ")]),t._v(" "),i("el-button",{attrs:{size:"small",icon:"el-icon-delete",disabled:!t.isAdmin},on:{click:t.sendInit}},[t._v("清空")]),t._v(" "),i("el-button",{attrs:{size:"small",type:"primary",icon:"el-icon-check",disabled:!t.isAdmin},on:{click:t.sendSubmit}},[t._v("发送\n          ")])],1)],1)])}),1)],1)},staticRenderFns:[]};var c=i("VU/8")(o,l,!1,function(t){i("JdDw")},"data-v-03c51a94",null);e.default=c.exports}});
//# sourceMappingURL=17.fbbc84ca9d66a35ef07f.js.map