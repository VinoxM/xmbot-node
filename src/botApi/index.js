import fs from 'fs-extra'
import path from 'path'
import {CQFunc,CQCode} from "../utils/CQCode";

const Api = {}

function loadApi() {
    const files = fs['readdirSync'](__dirname).filter(o => o !== 'index.js' && o.split('.').pop() === 'js')
    if (files && files.length > 0) {
        files.forEach(file => {
            let fileName = file.split('.')[0]
            Api[fileName] = require(path.join(__dirname, fileName))
        })
    }
}

loadApi()

const botApi = {}

function initApi(args, arr = ['qq']) {
    arr.forEach(e => {
        botApi[e] = Api[e].default
        let api = Api[e].default
        let arg = []
        if (args.length > 0 && Array.from(args).slice(2).indexOf(e) > -1) {
            arg = args.slice(0, 2)
        }
        global.LOG(`启动api:[${e}]`)
        api.initBot(arg)
    })
}

export default {
    botApi,
    initApi,
    closeApi: (arr) => {
        arr.forEach(e => {
            global.LOG(`关闭api:[${e}]`)
            botApi[e].closeBot()
            delete botApi[e]
        })
    },
    restartBot: (apiName, userId) => {
        if (!!apiName) {
            botApi[apiName].restartBot(userId)
        } else {
            for (const key of Object.keys(botApi)) {
                let botElem = botApi[key]
                botElem.restartBot(key === apiName ? userId : null)
            }
        }
    },
    restartApi: (apiName) => botApi[apiName].restartBot(),
    CQ: (apiName = 'qq') => botApi.hasOwnProperty(apiName)?botApi[apiName].CQ:CQCode[apiName],
    chatLog: (apiName) => botApi[apiName].chatLog,
    chatLogDb: (apiName) => botApi[apiName].chatLogDb.db,
    getChatLog: (apiName) => {
        if (apiName) {
            global['func'].getChatLog(apiName)
        } else {
            for (const key of Object.keys(botApi)) {
                global['func'].getChatLog(key)
            }
        }
    },
    replyMsg: (context, message, at) => {
        let apiName = context.apiName
        let fromApi = !!context['fromApi'] ? context['fromApi'] : 'qq'
        context['message'] = CQFunc.transformCq(context['message'], apiName, fromApi)
        botApi[apiName].replyMsg(context, message, at)
    },
    replyPrivate: (context) => {
        let apiName = context.apiName
        let fromApi = !!context['fromApi'] ? context['fromApi'] : 'qq'
        context['message'] = CQFunc.transformCq(context['message'], apiName, fromApi)
        botApi[apiName].replyPrivate(context)
    },
    replyGroup: (context, at) => {
        let apiName = context.apiName
        let fromApi = !!context['fromApi'] ? context['fromApi'] : 'qq'
        context['message'] = CQFunc.transformCq(context['message'], apiName, fromApi)
        botApi[apiName].replyGroup(context, at)
    },
    pushMsg: (msg, pushList) => {
        for (const key of Object.keys(pushList)) {
            let list = pushList[key]
            let message = CQFunc.transformCq(msg, key)
            if (list.hasOwnProperty('private')) {
                list.private.forEach(o => {
                    if (botApi.hasOwnProperty(key)) {
                        botApi[key].replyPrivate({message: message, user_id: o})
                    }
                })
            }
            if (list.hasOwnProperty('group')) {
                list.group.forEach(o => {
                    if (botApi.hasOwnProperty(key)) {
                        botApi[key].replyGroup({message: message, group_id: o})
                    }
                })
            }
        }
    }
}
